<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-post-index-js.0a8d5a94346334ad9e95.css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;margin:0;padding:0}h1{font-size:2.25rem}h1,h2{margin:0;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{margin:0;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{margin:0;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{margin:0;padding:0}ol,ul{padding:0;margin:0 0 0 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{margin:0;padding:0}pre{margin:0;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{margin:0;padding:0}blockquote{padding:0;margin:0 1.45rem}form,iframe,noscript{margin:0;padding:0}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{margin:0;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{font-family:Dank Mono,SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace}pre code{background:none;line-height:1.42}tt:after,tt:before{letter-spacing:-.2em;content:" "}pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 2.0.105"/><title data-react-helmet="true">Animation Worklet: The Missing Pieces | Inventing With Monster</title><meta data-react-helmet="true" name="description" content="There&#x27;s some glimmers of promise in the current Houdini Animation Worklet API proposal, but it won&#x27;t be fit for purpose without these changes."/><meta data-react-helmet="true" property="og:title" content="Animation Worklet: The Missing Pieces"/><meta data-react-helmet="true" property="og:description" content="There&#x27;s some glimmers of promise in the current Houdini Animation Worklet API proposal, but it won&#x27;t be fit for purpose without these changes."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@mattgperry"/><meta data-react-helmet="true" name="twitter:title" content="Animation Worklet: The Missing Pieces"/><meta data-react-helmet="true" name="twitter:description" content="There&#x27;s some glimmers of promise in the current Houdini Animation Worklet API proposal, but it won&#x27;t be fit for purpose without these changes."/><meta data-react-helmet="true" name="keywords" content="matt perry, popmotion, react, pose, popmotion pose, framer, framer motion, ui animation"/><style data-styled="fCCKrg  gUHxeD gAGEbe cmEtnx etXzyZ Eswij gDjIGT kIWHnr hTSynM dJGhSF bexhIO" data-styled-version="4.1.3">
/* sc-component-id: header__Container-sc-31ozxh-0 */
.gUHxeD{margin-bottom:100px;} @media (max-width:62em){.gUHxeD{margin-bottom:70px;}} @media (max-width:48em){.gUHxeD{margin-bottom:50px;}} @media (max-width:36em){.gUHxeD{margin-bottom:30px;}}
/* sc-component-id: header__Title-sc-31ozxh-1 */
.gAGEbe a{color:#1fedcb;-webkit-text-decoration:none;text-decoration:none;text-transform:uppercase;font-size:28px;} @media (max-width:48em){.gAGEbe a{font-size:24px;}} @media (max-width:36em){.gAGEbe a{font-size:18px;}}
/* sc-component-id: bits__Title-dkhe0b-0 */
.cmEtnx{color:#32005c;font-size:72px;font-weight:900;-webkit-letter-spacing:-1px;-moz-letter-spacing:-1px;-ms-letter-spacing:-1px;letter-spacing:-1px;text-transform:uppercase;text-align:center;margin-bottom:50px;} @media (max-width:48em){.cmEtnx{font-size:48px;}} @media (max-width:36em){.cmEtnx{text-align:left;font-size:32px;}}
/* sc-component-id: bits__ContentContainer-dkhe0b-1 */
.etXzyZ > *{display:block;margin:0 auto;max-width:650px;} .etXzyZ > p{font-size:18px;margin-bottom:25px;line-height:1.6;} .etXzyZ > p:first-child{font-size:24px;font-weight:600;line-height:1.4;} .etXzyZ > blockquote{border-left:2px solid #1fedcb;padding:20px;background:#f0f0f0;margin-bottom:25px;border-radius:5px;} .etXzyZ > ul,.etXzyZ > ol{margin-bottom:25px;} .etXzyZ h2,.etXzyZ h3{color:#31005C;text-transform:uppercase;font-size:36px;margin:50px auto 25px;} .etXzyZ h3{font-size:28px;} .etXzyZ a{-webkit-text-decoration:none;text-decoration:none;} .etXzyZ p code{background:rgba(33,237,203,0.2);padding:5px;border-radius:5px;} .etXzyZ .gatsby-highlight{margin-bottom:25px;max-width:700px;} .etXzyZ code[class*="language-"],.etXzyZ pre[class*="language-"]{-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre;white-space:pre-wrap;word-wrap:normal;font-size:16px;text-shadow:none;} .etXzyZ pre[class*="language-"],.etXzyZ:not(pre)>code[class*="language-"]{background:#333;color:#1fedcb;} .etXzyZ pre[class*="language-"]{padding:15px;border-radius:5px;overflow:auto;} .etXzyZ pre[class*="language-"]{position:relative;} .etXzyZ pre[class*="language-"] code{white-space:pre;display:block;} .etXzyZ:not(pre)>code[class*="language-"]{padding:0.15em 0.2em 0.05em;border-radius:.3em;box-shadow:1px 1px 0.3em -0.1em #000 inset;} .etXzyZ .token.namespace{opacity:.7;} .etXzyZ .token.comment,.etXzyZ .token.prolog,.etXzyZ .token.doctype,.etXzyZ .token.cdata{color:#6f705e;} .etXzyZ .token.operator,.etXzyZ .token.boolean,.etXzyZ .token.number{color:#a77afe;} .etXzyZ .token.attr-name,.etXzyZ .token.string{color:#FFDE4D;} .etXzyZ .token.entity,.etXzyZ .token.url,.etXzyZ .language-css .token.string,.etXzyZ .style .token.string{color:#FFDE4D;} .etXzyZ .token.selector,.etXzyZ .token.inserted{color:#a6e22d;} .etXzyZ .token.atrule,.etXzyZ .token.attr-value,.etXzyZ .token.keyword,.etXzyZ .token.important,.etXzyZ .token.deleted{color:#F5148C;} .etXzyZ .token.regex,.etXzyZ .token.statement{color:#76d9e6;} .etXzyZ .token.placeholder,.etXzyZ .token.variable{color:#fff;} .etXzyZ .token.important,.etXzyZ .token.statement,.etXzyZ .token.bold{font-weight:bold;} .etXzyZ .token.punctuation{color:#bebec5;} .etXzyZ .token.entity{cursor:help;} .etXzyZ .token.italic{font-style:italic;} .etXzyZ code.language-markup{color:#f9f9f9;} .etXzyZ code.language-markup .token.tag{color:#F5148C;} .etXzyZ code.language-markup .token.attr-name{color:#a6e22d;} .etXzyZ code.language-markup .token.attr-value{color:#FFDE4D;} .etXzyZ code.language-markup .token.style,.etXzyZ code.language-markup .token.script{color:#76d9e6;} .etXzyZ code.language-markup .token.script .token.keyword{color:#76d9e6;} .etXzyZ pre[class*="language-"][data-line]{position:relative;padding:1em 0 1em 3em;} .etXzyZ pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:0;margin-top:1em;background:rgba(255,255,255,0.08);pointer-events:none;line-height:inherit;white-space:pre;} .etXzyZ pre[data-line] .line-highlight:before,.etXzyZ pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0.2em 0.5em;background-color:rgba(255,255,255,0.4);color:black;font:bold 65%/1 sans-serif;height:1em;line-height:1em;text-align:center;border-radius:999px;text-shadow:none;box-shadow:0 1px 1px rgba(255,255,255,0.7);} .etXzyZ pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em;} @media (max-width:48em){.etXzyZ > p:first-child{font-size:18px;}.etXzyZ h2{font-size:28px;}.etXzyZ h3{font-size:18px;}} @media (max-width:36em){.etXzyZ h2{font-size:24px;}}
/* sc-component-id: footer__Container-r54yyk-0 */
.dJGhSF{margin-top:40px;border-top:1px solid #eee;padding-bottom:20px;} .dJGhSF p{margin-bottom:10px;}
/* sc-component-id: footer__Avatar-r54yyk-1 */
.bexhIO{width:70px;height:70px;border-radius:50%;margin-right:20px;float:left;} @media (max-width:36em){.bexhIO{width:32px;height:32px;}}
/* sc-component-id: sc-global-2230081131 */
body{padding:10px;background:linear-gradient(180deg,#1fedcb,#31005C);min-height:100vh;} body > *{font-family:'Source Sans Pro',sans-serif;font-weight:400;} body a{color:#F5148C;} body h1,body h1 *,body h2,body h2 *,body h3,body h4,body h5,body h6{font-family:'Raleway',sans-serif;font-weight:900;line-height:0.8;}
/* sc-component-id: layout__Container-ii2kc2-0 */
.fCCKrg{background:#fff;min-height:calc(100vh - 20px);padding:30px;} @media (max-width:48em){.fCCKrg{padding:20px;}} @media (max-width:36em){.fCCKrg{padding:10px;}}
/* sc-component-id: Author__Container-sc-1jp4vsk-0 */
.Eswij{display:-webkit-box !important;display:-webkit-flex !important;display:-ms-flexbox !important;display:flex !important;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-size:16px;margin-bottom:20px;}
/* sc-component-id: Author__Avatar-sc-1jp4vsk-1 */
.gDjIGT{width:40px;height:40px;border-radius:50%;margin-right:10px;} @media (max-width:36em){.gDjIGT{width:32px;height:32px;}}
/* sc-component-id: Author__Name-sc-1jp4vsk-2 */
.kIWHnr{font-weight:600;}
/* sc-component-id: Author__Seperator-sc-1jp4vsk-3 */
.hTSynM{margin:0 10px;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link href="https://fonts.googleapis.com/css?family=Raleway:900|Source+Sans+Pro:400,600" rel="stylesheet"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#fff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><link as="script" rel="preload" href="/component---src-templates-post-index-js-9760a44efc4dab5a61d8.js"/><link as="script" rel="preload" href="/0-e0044090e84111225085.js"/><link as="script" rel="preload" href="/app-235d3078e23068b14c64.js"/><link as="script" rel="preload" href="/webpack-runtime-07eb0fb59b048476daad.js"/><link as="fetch" rel="preload" href="/static/d/12/path---20200203-animationworklet-the-missing-pieces-d-85-d8a-DiYppA30qAdimI2t1g9KYnql1P0.json" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="layout__Container-ii2kc2-0 fCCKrg"><header class="header__Container-sc-31ozxh-0 gUHxeD"><h2 class="header__Title-sc-31ozxh-1 gAGEbe"><a href="/">Inventing With Monster</a></h2></header><article><h1 class="bits__Title-dkhe0b-0 cmEtnx">Animation Worklet: The Missing Pieces</h1><div class="bits__ContentContainer-dkhe0b-1 etXzyZ"><div class="Author__Container-sc-1jp4vsk-0 Eswij"><img src="/static/photo-of-matt-perry-78cf3c1b9af9e4daa9e56cc77b940835.jpg" alt="" class="Author__Avatar-sc-1jp4vsk-1 gDjIGT"/><span class="Author__Name-sc-1jp4vsk-2 kIWHnr">Matt Perry</span><span class="Author__Seperator-sc-1jp4vsk-3 hTSynM">|</span>03 Feb 2020</div></div><div class="bits__ContentContainer-dkhe0b-1 etXzyZ"><p>The upcoming <a href="https://developers.google.com/web/updates/2018/10/animation-worklet">Animation Worklet</a> promises to let developers write performant animations and gestures. But until it adds a few missing pieces, it isn’t ready for the job.</p>
<p>Animation Worklet is part of an interweaving suite of browser APIs collectively called CSS Houdini. Together, they’ll offer developers low-level access to various parts of the rendering engine like paint, layout, and of relevance to us, animation.</p>
<p>I’ve been writing <a href="https://popmotion.io/pure">animation</a> <a href="https://framer.com/motion">libraries</a> for over six years to try and help push web UI animations beyond simple easing curves. These libraries, and others like them, probably wouldn’t exist if browsers already offered spring, physics or scroll-bound animations.</p>
<p>Instead, it’s left to developers to fill in the gaps. Today, we’re forced to do so by running our code in the <a href="https://developer.mozilla.org/en-US/docs/Glossary/Main_thread">main thread</a> via <code class="language-text">requestAnimationFrame</code>. If you’re running an animation or a gesture and your site suffers heavy computational load, users will experience visual jank and sluggishness.</p>
<p>Animation Worklet is a potential silver bullet that could give developers a similar freedom. Worklets run off the main thread so your users are provided a smooth, app-quality experience.</p>
<p>But that’s <em>if</em> the API reaches its full potential. As far as “if”s go, I put that one in italics.</p>
<p>A quick glance at <a href="http://ishoudinireadyyet.com/">Is Houdini Ready Yet?</a> shows that Animation Worklet suffers some of the poorest support of all the Houdini APIs. For good reason: It isn’t fully specced yet, and what has been specced falls short of what I would consider an MVP.</p>
<p>If you’re new to Animation Worklet I highly recommend playing with <a href="https://codesandbox.io/s/animation-worklet-api-template-vw0mk">this CodeSandbox sandbox</a> while you read <a href="https://developers.google.com/web/updates/2018/10/animation-worklet">Google’s introductory blog post</a>, which covers the basics of the upcoming API.</p>
<p>If you’re all caught up, let’s take a look at the missing pieces that we need from this API if it’s to live up to its tremendous potential.</p>
<h2 id="a-note-on-odd-choices"><a href="#a-note-on-odd-choices" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A note on odd choices</h2>
<p>Before we get into this, I want to make it clear that I think there’s some odd choices in the Animation Worklet API.</p>
<p>For instance, I don’t understand why we manipulate <code class="language-text">localTime</code> to generate animation effects. The no-op implementation is easy to explain:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">animate</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  effect<span class="token punctuation">.</span>localTime <span class="token operator">=</span> currentTime
<span class="token punctuation">}</span></code></pre></div>
<p>But conceptually it breaks down in most real-world situations.</p>
<p>Spring animations have no preset <code class="language-text">duration</code>, so it’s odd that we could affect one by changing this in the provided <code class="language-text">KeyframeEffect</code>.</p>
<p>Likewise, the oddly-named <code class="language-text">ScrollTimeline</code> has a <code class="language-text">timeRange</code> option which itself is a bit of a hack to bend a spacial concept of progress into a time one.</p>
<p>What both of use-cases share in common with a duration-based easing animation is an <strong>origin</strong>, a <strong>target</strong>, and a <strong>progress</strong> to describe an interpolation between the two. So manipulating something more abstract like a <code class="language-text">0</code>-<code class="language-text">1</code> <code class="language-text">effect.progress</code> value would make more sense to me.</p>
<p>However, <code class="language-text">localTime</code> is merely an odd choice, and I’m not overly concerned by odd choices.</p>
<p>They confuse the API and thus make wrapper libraries critical in lowering the barrier to adoption.</p>
<p>They aren’t show-stoppers though. So the following is a list of things that we currently <em>can’t</em> do, not just things that are merely hard or confusing to do.</p>
<h2 id="1-i-am-complete"><a href="#1-i-am-complete" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. I am complete</h2>
<p>Currently, there’s no specced method for an animation to declare itself complete.</p>
<p>With no cheap or synchronous way to read the output of an Animation Worklet from the main thread there’s also no way to sensibly declare an animation finished externally, either.</p>
<p>This means that, once started, an animation will run every frame until either the animating component is unmounted or another animation is started in its place.</p>
<p>So worklets bound to the document timeline will continue to accumulate like cruft over a page session, needlessly running once per frame, potentially negating the performance benefits they’re designed to avoid.</p>
<p>It also becomes impossible to write code that executes when an animation is finished. So none of this:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">await</span> <span class="token function">animate</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This will never happen</span></code></pre></div>
<p>Any API like <code class="language-text">this.cancel()</code>, <code class="language-text">effect.playState = &quot;finished&quot;</code>, or <code class="language-text">this.timeline.detach(this)</code> would be an acceptable and simple solution.</p>
<p>In Google’s <a href="https://github.com/GoogleChromeLabs/houdini-samples/blob/master/animation-worklet/spring-sticky/spring-sticky-animator.js">Spring Sticky demo</a>, there’s the concept of a worklet attaching and detaching itself from a timeline passed in via the worklet’s options:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>documentTimeline<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>A concept like this is very powerful and would solve this problem, as long as a worklet also had access to its “primary” timeline (the one passed as <code class="language-text">WorkletAnimation</code>’s third argument).</p>
<p>In the example it’s even better, as they’re passing reference to both the <code class="language-text">DocumentTimeline</code> and an element’s <code class="language-text">ScrollTimeline</code>, so the worklet can choose when to be driven by each.</p>
<p>Sadly, this is only possible by exploiting a bug in the Animation Worklet polyfill, as the spec itself (and indeed its Chrome implementation) requires all options to be serialisable. There is talk of adding more <a href="https://github.com/w3c/csswg-drafts/issues/2493">general inputs</a> which will be even better than the weird concepts of “scroll timeline”, so hopefully this comes to fruition.</p>
<p><a href="https://github.com/w3c/css-houdini-drafts/issues/808">Follow this issue on GitHub</a></p>
<h2 id="2-velocity"><a href="#2-velocity" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Velocity</h2>
<p>One of the examples given in the API’s <a href="https://github.com/w3c/css-houdini-drafts/blob/master/css-animationworklet/README.md">Motivating Use Cases</a> is “spring physics”, and indeed this is one of the main use-cases I have for my libraries.</p>
<p>Spring animations have unique value over standard easing animations because they can incorporate velocity from an existing animation, like a drag gesture or easing. They’re interruptable without the complexity of cross fading or additive animation tricks.</p>
<p>Because of this physics-based approach they create naturalistic and engaging UIs that reflect the user’s energy.</p>
<p>Google have already made <a href="https://github.com/GoogleChromeLabs/houdini-samples/blob/master/animation-worklet/spring-timing/spring-timing-animator.js">a spring example</a> and at first glance it looks like this is implementable as soon as we get the ability for an animation to declare itself complete.</p>
<p>However, there no current way for a worklet to report its velocity to be incorporated into subsequent animations.</p>
<p>It is currently feasible to feed an initial velocity via <code class="language-text">option</code>s. With some mental leaps it’s probably possible to wrangle velocity into something meaningful to the <code class="language-text">effect.localTime</code> abstraction.</p>
<p>Until there’s a way to fish velocity back out of a worklet, this capability is for nothing.</p>
<p>A hypothetical velocity wouldn’t need to be permanently accessible, only when an animation is finished. So there’d be no per-frame main thread nonsense to worry about.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">await</span> animation<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> velocity <span class="token operator">=</span> animation<span class="token punctuation">.</span>localTimeVelocity<span class="token punctuation">;</span></code></pre></div>
<p>Alternatively a timestamped history of the last few resolved values (ie <code class="language-text">translateX</code> as pixels) would be enough to calculate a velocity.</p>
<p>Or, there’s the possibility of writing monolithic worklets that control all animations and gestures for the duration of a value’s lifecycle. With the ability to <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=932619">send data to an Animation Worklet</a> it’d be possible to track velocity within the worklet itself. But without unclamped keyframes (which we’ll get to next), this wouldn’t be a practical match with the current <code class="language-text">KeyframeEffect</code> API.</p>
<p><a href="https://github.com/w3c/css-houdini-drafts/issues/976">Follow this issue on GitHub</a></p>
<h2 id="3-unclamped-keyframes"><a href="#3-unclamped-keyframes" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. Unclamped keyframes</h2>
<p>The only way we can run keyframe animations with an Animation Worklet is by creating a <code class="language-text">KeyframeEffect</code>. It can be configured in the main thread with all kinds of options like <code class="language-text">duration</code> and <code class="language-text">easing</code>.</p>
<p>However, if a <code class="language-text">KeyframeEffect</code> receives a <code class="language-text">localTime</code> outside of <code class="language-text">0</code> and its <code class="language-text">duration</code> (actually, oddly, 1 millisecond before), it outputs an invalid value and the animating values are reset to default.</p>
<p>We can demonstrate this by opening <a href="https://codesandbox.io/s/animation-worklet-api-template-vw0mk">the CodeSandbox sandbox in Chrome</a> (turn on Experimental Web Features in <code class="language-text">chrome://flags</code> if you haven’t already).</p>
<p>In <code class="language-text">index.js</code> we call the <code class="language-text">KeyframeEffect</code> with a <code class="language-text">duration</code> of <code class="language-text">1000</code>. If in <code class="language-text">worklet.js</code> we write:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">effect<span class="token punctuation">.</span>localTime <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span></code></pre></div>
<p>We can see the animation is on the final frame. If we change that to a value outside of the provided <code class="language-text">duration</code>:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">effect<span class="token punctuation">.</span>localTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// or</span>
effect<span class="token punctuation">.</span>localTime <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">KeyframeEffect</code> produces an invalid value, and the transform breaks completely. Practically speaking, <strong>it’s clamped</strong>.</p>
<p>This is a major problem when creating spring animations or extending <code class="language-text">KeyframeEffect</code> with non-standard easing effects that overshoot the provided keyframes range.</p>
<p>The sane way to implement new easing functions would be to simply apply easing to <code class="language-text">currentTime</code> and apply that directly to <code class="language-text">effect.localTime</code>.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// worklet.js</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> easing <span class="token keyword">from</span> <span class="token string">"@popmotion/easing"</span><span class="token punctuation">;</span>

<span class="token function">registerAnimation</span><span class="token punctuation">(</span>
  <span class="token string">"tween"</span><span class="token punctuation">,</span>
  <span class="token keyword">class</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">{</span> duration <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span> easing <span class="token operator">=</span> <span class="token string">"backOut"</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> duration<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>easing <span class="token operator">=</span> easing<span class="token punctuation">[</span>easing<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">animate</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> progress <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>currentTime <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>duration<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> easedProgress <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      effect<span class="token punctuation">.</span>localTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">*</span> easedProgress<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Depending on the under or overshoot effects of <code class="language-text">easing</code>, the value of <code class="language-text">easedProgress</code> could quite easily be <code class="language-text">-0.1</code> or <code class="language-text">1.2</code>.</p>
<p>Applying this to an ideal <code class="language-text">KeyframeEffect</code> that could gracefully handle times outside of its defined <code class="language-text">duration</code> would result in appropriately eased motion. As it’s implemented today, the animation would simply break.</p>
<p>Google’s spring example from before has an <a href="https://github.com/GoogleChromeLabs/houdini-samples/blob/master/animation-worklet/spring-timing/index.html#L68">interesting hack to avoid this</a>. They multiply the target by <code class="language-text">2</code> to give the animation headroom to overshoot without breaking, and then use that doubled target as <code class="language-text">duration</code>.</p>
<p>A wrapper library could hide this added complexity, but the hack only works with two caveats:</p>
<ol>
<li>The origin is <code class="language-text">0</code>.</li>
<li>The origin and target are both of the same unit type (in this case, pixels).</li>
</ol>
<p>Point one makes the solution increasingly unpleasant but it is addressable. The second is the real killer.</p>
<p>The best thing about using <code class="language-text">KeyframeEffect</code> is it can animate between different value types. Framer Motion also has this ability but it does so by expensively measuring an element, applying the target styles and measuring it again.</p>
<p>That code is extra baggage in terms of payload, execution speed, and maintenance. But it’d still be necessary in this situation because this hack only works with value types that are the same, and says nothing about <code class="language-text">calc()</code> values.</p>
<p>With an unclamped <code class="language-text">KeyframeEffect</code> this complexity would disappear.</p>
<h2 id="4-transforming-values"><a href="#4-transforming-values" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Transforming values</h2>
<p>In Framer Motion, there’s a function called <code class="language-text">transform</code>. It transforms values from one range into another:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b === 0.5</span></code></pre></div>
<p>It’s very powerful. It can translate from two or more linear numbers into non-linear numbers, colors, or complex strings.</p>
<p>In this demo, each app icon is passively transforming its scale and position from the position of the pannable container.</p>
<iframe
  src="https://codesandbox.io/embed/goofy-hill-6j6l074q9r?fontsize=14&hidenavigation=1&theme=dark"
  style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;margin-bottom: 50px;"
  title="Framer Motion: Apple Watch Dock"
  allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"
></iframe>
<p>In combination with pointer events and an unclamped <code class="language-text">KeyframeEvent</code>, the ability to do all this away from the main thread would be very powerful.</p>
<p>It isn’t possible with the API as specced today, but you could perhaps imagine the ability to pass an existing <code class="language-text">WorkletAnimation</code> as a <code class="language-text">timeline</code> option or <code class="language-text">input</code> to a special <code class="language-text">&quot;transform&quot;</code> worklet.</p>
<h2 id="in-conclusion"><a href="#in-conclusion" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>In Conclusion</h2>
<p>As an animation geek, the Animation Worklet is the only browser API on the horizon that I care about. I really want it to live up to its potential, and its promise.</p>
<p>I haven’t touched on the absence of pointer events, but there does seem to be <a href="https://github.com/WICG/input-for-workers">concerted effort</a> to building support for these for all worklet types.</p>
<p>Between pointer support and a solution for completing animations, querying velocity, unclamping <code class="language-text">KeyframeEffect</code>, or transforming values, in the real world Animation Worklet isn’t currently capable of much more than parallax effects.</p>
<p>Given the teeth-pulling process of getting cross-browser support for new APIs, I hope we can get these fixed in the current spec before its finalised.</p></div></article><footer class="bits__ContentContainer-dkhe0b-1 etXzyZ"><div class="footer__Container-r54yyk-0 dJGhSF"><h2>About me</h2><img src="/static/photo-of-matt-perry-78cf3c1b9af9e4daa9e56cc77b940835.jpg" alt="" class="footer__Avatar-r54yyk-1 bexhIO"/><p>Hey! I’m Matt Perry. I write<!-- --> <a href="https://framer.com/motion">Framer Motion</a> and take the<!-- --> <a href="https://instagram.com/inventingwithmonster">occasional photo</a>.</p><p><a href="https://twitter.com/mattgperry">Twitter</a> |<!-- --> <a href="https://github.com/inventingwithmonster">Github</a></p></div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-index-js","jsonName":"20200203-animationworklet-the-missing-pieces-d85","path":"/20200203-animationworklet-the-missing-pieces/"};window.dataPath="12/path---20200203-animationworklet-the-missing-pieces-d-85-d8a-DiYppA30qAdimI2t1g9KYnql1P0";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-235d3078e23068b14c64.js"],"component---src-templates-post-index-js":["/component---src-templates-post-index-js.0a8d5a94346334ad9e95.css","/component---src-templates-post-index-js-9760a44efc4dab5a61d8.js"],"component---src-pages-404-js":["/component---src-pages-404-js.0a8d5a94346334ad9e95.css","/component---src-pages-404-js-e8fdcf1e493ad4419eb1.js"],"component---src-pages-index-js":["/component---src-pages-index-js.0a8d5a94346334ad9e95.css","/component---src-pages-index-js-70d6b647f2c27d399748.js"],"pages-manifest":["/pages-manifest-661c958c0275b9bba9d9.js"]};/*]]>*/</script><script src="/webpack-runtime-07eb0fb59b048476daad.js" async=""></script><script src="/app-235d3078e23068b14c64.js" async=""></script><script src="/0-e0044090e84111225085.js" async=""></script><script src="/component---src-templates-post-index-js-9760a44efc4dab5a61d8.js" async=""></script></body></html>
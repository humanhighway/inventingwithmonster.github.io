(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{"/+yk":function(e,a,t){"use strict";var n=t("q1tI"),s=t.n(n),c=t("Bl7J"),o=t("vrFN"),i=t("p6Wu"),b=(t("pJf4"),t("I/2l")),r=t.n(b),p=t("vOnD"),l=t("VBu3");function m(){var e=function(e,a){a||(a=e.slice(0));return e.raw=a,e}(["\n    width: 32px;\n    height: 32px;\n  "]);return m=function(){return e},e}var j={mattperry:{img:r.a,name:"Matt Perry"}},g=p.d.div.withConfig({displayName:"Author__Container",componentId:"sc-1jp4vsk-0"})(["display:flex !important;align-items:center;font-size:16px;margin-bottom:20px;"]),O=p.d.img.withConfig({displayName:"Author__Avatar",componentId:"sc-1jp4vsk-1"})(["width:40px;height:40px;border-radius:50%;margin-right:10px;",""],l.a.phone(m())),u=p.d.span.withConfig({displayName:"Author__Name",componentId:"sc-1jp4vsk-2"})(["font-weight:600;"]),d=p.d.span.withConfig({displayName:"Author__Seperator",componentId:"sc-1jp4vsk-3"})(["margin:0 10px;"]),N=function(e){var a=e.id,t=void 0===a?"mattperry":a,n=e.date;return j[t]?s.a.createElement(g,null,s.a.createElement(O,{src:j[t].img,alt:""}),s.a.createElement(u,null,j[t].name),s.a.createElement(d,null,"|"),n):null};a.a=function(e){var a=e.children,t=e.pageContext,n=t.date,b=t.frontmatter,r=b.title,p=b.description,l=b.author;return s.a.createElement(c.a,null,s.a.createElement(o.a,{title:r,description:p,keywords:["matt perry","popmotion","react","pose","popmotion pose","framer","framer motion","ui animation"]}),s.a.createElement("article",null,s.a.createElement(i.b,null,r),s.a.createElement(i.a,null,s.a.createElement(N,{id:l,date:n})),s.a.createElement(i.a,null,a)))}},fJXz:function(e,a,t){"use strict";t.r(a),t.d(a,"_frontmatter",(function(){return b})),t.d(a,"default",(function(){return l}));t("rzGZ"),t("Dq+y"),t("8npG"),t("Ggvi"),t("E5k/"),t("q1tI");var n=t("7ljp"),s=t("/+yk"),c=t("8D1i"),o=t("i2M9"),i=t("aqM1");var b={},r={_frontmatter:b},p=s.a;function l(e){var a=e.components,t=function(e,a){if(null==e)return{};var t,n,s={},c=Object.keys(e);for(n=0;n<c.length;n++)t=c[n],a.indexOf(t)>=0||(s[t]=e[t]);return s}(e,["components"]);return Object(n.b)(p,Object.assign({},r,t,{components:a,mdxType:"MDXLayout"}),Object(n.b)("p",null,"Magic Motion is a powerful new feature in ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://framer.com"}),"Framer")," that allows designers to link any two frames and smoothly animate between them."),Object(n.b)("p",null,"Magic Motion is built on the new ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://framer.com/api/motion/animation/#automatic-(beta)"}),"auto-animate")," and ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://framer.com/api/motion/animate-shared-layout"}),"shared layout")," features in Framer Motion 2. So as a developer, handoff isn’t a pit-of-the-stomach experience, or a hasty “you can’t do that on the web!”"),Object(n.b)("p",null,"Implementing a Magic Motion prototype as a production-ready, URL-driven animation between completely different views is just a few lines of React markup:"),Object(n.b)("iframe",{src:"https://codesandbox.io/embed/framer-motion-magic-motion-app-store-demo-su6mx?fontsize=14&theme=light",style:{width:"100%",height:"500px",border:"0",borderRadius:"4px",overflow:"hidden",marginBottom:"40px"},title:"Framer Motion: Magic Motion App Store demo",allow:"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb",sandbox:"allow-modals allow-forms allow-popups allow-scripts allow-same-origin"}),Object(n.b)("p",null,"Crucially, Framer Motion performs all these layout animations at 60fps. In this this post, we’re going to learn how."),Object(n.b)("h2",{id:"the-problem",style:{position:"relative"}},Object(n.b)("a",Object.assign({parentName:"h2"},{href:"#the-problem","aria-label":"the problem permalink",className:"anchor before"}),Object(n.b)("svg",Object.assign({parentName:"a"},{"aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"}),Object(n.b)("path",Object.assign({parentName:"svg"},{fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"})))),"The Problem"),Object(n.b)("p",null,"CSS offers a number of different layout systems, that are all compatible with each other. A flexbox could be placed with in an absolutely positioned grid that sits within a static ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"float: right"),"."),Object(n.b)("p",null,"With all these possibilities, calculating how a webpage should look is expensive. At 60fps a browser has just 16.6 milliseconds to update the screen before the next frame. It’s unlikely, and this is why browsers don’t offer a way to animate layout."),Object(n.b)("p",null,"Take this switch, which is laid out using a simple flexbox. Even with ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"transition: all"),", changing ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"justify-content")," has an instant effect:"),Object(n.b)(c.a,{animations:!1,mdxType:"Switch"}),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"switch ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"{"),"\n  justify",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"-"),"content",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),":")," align",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"-"),"start",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\n  transition",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),":")," all",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"switch",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"on ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"{"),"\n  justify",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"-"),"content",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),":")," align",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"-"),"end",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"}")))),Object(n.b)("p",null,"So front-end developers are limited in their options. Ideally, using only ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://csstriggers.com/"}),"compositable properties")," like ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"transform")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"opacity"),". Properties like ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"background-color")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"box-shadow")," trigger paint, which isn’t ideal, but sometimes it’s unavoidable."),Object(n.b)("p",null,"What we ideally want then, is a way of animating layout using only transforms."),Object(n.b)("h2",{id:"flip",style:{position:"relative"}},Object(n.b)("a",Object.assign({parentName:"h2"},{href:"#flip","aria-label":"flip permalink",className:"anchor before"}),Object(n.b)("svg",Object.assign({parentName:"a"},{"aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"}),Object(n.b)("path",Object.assign({parentName:"svg"},{fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"})))),"FLIP"),Object(n.b)("p",null,"The technique at the core of performant layout transitions in the browser was first described by ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://aerotwist.com/blog/flip-your-animations/"}),"Paul Lewis"),"."),Object(n.b)("p",null,"It’s called FLIP, which stands for ",Object(n.b)("strong",{parentName:"p"},"F"),"irst, ",Object(n.b)("strong",{parentName:"p"},"L"),"ast, ",Object(n.b)("strong",{parentName:"p"},"I"),"nvert, ",Object(n.b)("strong",{parentName:"p"},"P"),"lay."),Object(n.b)("p",null,"That is, we:"),Object(n.b)("ol",null,Object(n.b)("li",{parentName:"ol"},"Measure the first layout"),Object(n.b)("li",{parentName:"ol"},"Update the CSS and measure the last layout"),Object(n.b)("li",{parentName:"ol"},"Apply the inverted delta as a ",Object(n.b)("code",Object.assign({parentName:"li"},{className:"language-text"}),"transform")," to make the last layout look like the first"),Object(n.b)("li",{parentName:"ol"},"Play the animation")),Object(n.b)("p",null,"So we do the expensive thing (layout) at the start of the animation, where we have a window of time where the user won’t notice heavy work. Then we do the cheap thing (animating ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"transform"),") once per frame."),Object(n.b)("p",null,"For very simple use-cases, this is enough to smoothly animate layout:"),Object(n.b)(c.a,{mdxType:"Switch"}),Object(n.b)("p",null,"But there’s a drawback to FLIP that can instantly wreck the illusion. ",Object(n.b)("strong",{parentName:"p"},"Scale distortion"),"."),Object(n.b)("p",null,"By replacing the animation of ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"width")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"height")," with ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"scaleX")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"scaleY"),", everything style that was bound to that width and height is visibly broken. This includes ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"box-shadow"),", ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-radius"),", and the size and styles of any children too."),Object(n.b)("p",null,"Try clicking on this box and notice the types of distortions seen when toggling between its two visual states."),Object(n.b)(o.a,{mdxType:"Distorted"}),Object(n.b)("p",null,"Magic Motion’s key innovation is the ability to correct all of this visual distortion, throughout an infinitely deep tree:"),Object(n.b)(o.d,{mdxType:"Undistorted"}),Object(n.b)("p",null,"This is ",Object(n.b)("strong",{parentName:"p"},"scale correction"),". We apply it to CSS properties that can be corrected without triggering layout, like ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"box-shadow")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-radius"),"."),Object(n.b)("p",null,"It’s applied throughout a tree on any component that a user has set to automatically animate:"),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token tag"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token tag"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),"<"),"motion.div")," ",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token attr-name"}),"animate")," ",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),"/>"))))),Object(n.b)("p",null,"Or has included in a shared element transition:"),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token tag"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token tag"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),"<"),"motion.div")," ",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token attr-name"}),"layoutId"),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),'"'),"header",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token punctuation"}),"/>"))))),Object(n.b)("p",null,"In the future, we may bring scale correction to all ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"motion")," components."),Object(n.b)("h2",{id:"correcting-css-styles",style:{position:"relative"}},Object(n.b)("a",Object.assign({parentName:"h2"},{href:"#correcting-css-styles","aria-label":"correcting css styles permalink",className:"anchor before"}),Object(n.b)("svg",Object.assign({parentName:"a"},{"aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"}),Object(n.b)("path",Object.assign({parentName:"svg"},{fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"})))),"Correcting CSS Styles"),Object(n.b)("p",null,"Correcting the appearance of ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-radius")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"box-shadow")," is a three step process."),Object(n.b)("p",null,"First, if we’re animating between two different values, we interpolate between those."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," borderRadius ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"mix"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"origin",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," target",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," time",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"Second, we keep a record of the “actual”, pre-correction value. If the animation is interrupted, the next animation will start from this rather than the final scale-corrected value (which might have no relevance in a future scale context)."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"this"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"current",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"borderRadius ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," borderRadius",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"Finally, we apply the scale correction."),Object(n.b)("p",null,"The ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-radius")," style can be set per-corner with styles like ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-top-left-radius"),". Each corner can accept two values, one for each axis. So to correct for each axis, we divide the current ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-radius")," once by the scale of each."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," x ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," borderRadius ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"/")," scaleX",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," y ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," borderRadius ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"/")," scaleY",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\nelement",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"style",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),"borderTopLeftRadius ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token template-string"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token template-punctuation string"}),"`"),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token interpolation-punctuation punctuation"}),"${"),"x",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token interpolation-punctuation punctuation"}),"}")),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token string"}),"px "),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token interpolation-punctuation punctuation"}),"${"),"y",Object(n.b)("span",Object.assign({parentName:"span"},{className:"token interpolation-punctuation punctuation"}),"}")),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token string"}),"px"),Object(n.b)("span",Object.assign({parentName:"span"},{className:"token template-punctuation string"}),"`")),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"box-shadow")," has an ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"x")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"y")," setting that be corrected in the same way, but it also has ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"blur")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"spread")," that don’t have single-axis controls. To correct these values, we take an average scale and apply that to both instead:"),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," averageScale ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"mix"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"scaleX",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," scaleY",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token number"}),"0.5"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\nblur ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," blur ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"/")," averageScale",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\nspread ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," spread ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"/")," averageScale",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"This works pretty well but it isn’t perfect. The limitations of this approach are increasingly obvious with more extreme ratios of x/y distortion:"),Object(n.b)(i.a,{mdxType:"ShadowRatio"}),Object(n.b)("p",null,"But generally the ratios we animate from/to are similar enough that the ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"blur")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"spread")," scale correction looks pretty good. In the future there may be some weighting we can do to stop the more extreme distortions."),Object(n.b)("p",null,"Correcting these two styles fixes most of the visual distortion on a component. But we’re still left with the distortion of children."),Object(n.b)("h2",{id:"correcting-child-components",style:{position:"relative"}},Object(n.b)("a",Object.assign({parentName:"h2"},{href:"#correcting-child-components","aria-label":"correcting child components permalink",className:"anchor before"}),Object(n.b)("svg",Object.assign({parentName:"a"},{"aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"}),Object(n.b)("path",Object.assign({parentName:"svg"},{fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"})))),"Correcting Child Components"),Object(n.b)("p",null,"Without child correction, the shape of this round ball becomes distorted as its parent changes ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"scaleX"),":"),Object(n.b)(o.c,{mdxType:"IndependentBroken"}),Object(n.b)("p",null,"In addition, it would be impossible to also try and reliably animate this ball’s ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"x")," position, because the space through which it travels through would itself be stretching and squashing. This would lead to very uneven motion, like it was sat upon lapping waves."),Object(n.b)("p",null,"Correcting child distortion is where we start to pull away from the literal technique of FLIP and adhere to it more in principle."),Object(n.b)("p",null,"The first step is to loop through every animating component and remove any currently animating styles. Then, we snapshot their layout in a second pass."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),"children",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"forEach"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token parameter"}),"child"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=>")," child",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"reset"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\nchildren",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"forEach"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token parameter"}),"child"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=>")," child",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"snapshot"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"By batching the reads and writes in this way we prevent ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing"}),"layout thrashing"),". In Framer, a prototype might have hundreds of animating components, so optimising this can have a profound effect on performance."),Object(n.b)("p",null,"We also ensure we’re snapshotting every component as it will exist on the screen in its final state, unaffected by the ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"transform")," of its parent(s)."),Object(n.b)("p",null,"This is important, because it means we can then track, within a tree, all of the transforms we’ve applied to each component, then use this to correct the appearance of its children."),Object(n.b)("p",null,"Because we want to play the animation of every component independently of this tree transform (to avoid the lapping waves), each component has a shadow bounding box. This gets interpolated from its visual origin to its target once per frame."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," latest ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"mix"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"origin",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," target",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," time",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"The ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"target")," is ",Object(n.b)("strong",{parentName:"p"},"usually")," the same as the measured last layout (the ",Object(n.b)("strong",{parentName:"p"},"L")," in FLIP), but for some effects like ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"AnimateSharedLayout"),"’s crossfade it might be somewhere else on screen. Either way, we now know where on the screen we want our component to appear visually."),Object(n.b)("p",null,"We use this information to calculate the delta between where we want the component to appear, and where it actually is."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," delta ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"calcDelta"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"latest",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," actualPosition",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"The component saves this ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"delta")," to a context that all of its children have access to. The component itself might also have some parent deltas that it has to correct for. So before calculating ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"delta")," we first apply all the latest parent deltas to the actual measured position."),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," latest ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"mix"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"origin",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," target",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," t",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," transformedPosition ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"applyParentDeltas"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"actualPosition",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," parentDeltas",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," delta ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token function"}),"calcDelta"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),"("),"latest",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),",")," transformedPosition",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"This is how the scale correction is performed. By applying ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"parentDeltas")," to the actual position, we are then just left with figuring out how to get from there to our desired visual position."),Object(n.b)("p",null,"As a final step, we also use ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"parentDeltas")," to calculate the combined scale of the tree. We can use this on the CSS style corrections from before, so they correct parent distortions too:"),Object(n.b)("div",{className:"gatsby-highlight","data-language":"jsx"},Object(n.b)("pre",Object.assign({parentName:"div"},{className:"language-jsx"}),Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-jsx"}),Object(n.b)("span",Object.assign({parentName:"code"},{className:"token keyword"}),"const")," x ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"=")," borderRadius ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"/")," scaleX ",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token operator"}),"/")," treeScaleX",Object(n.b)("span",Object.assign({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"Our ball now stays the correct size, and can even animate through scaled space even as it distorts around it:"),Object(n.b)(o.b,{mdxType:"Independent"}),Object(n.b)("h2",{id:"conclusion",style:{position:"relative"}},Object(n.b)("a",Object.assign({parentName:"h2"},{href:"#conclusion","aria-label":"conclusion permalink",className:"anchor before"}),Object(n.b)("svg",Object.assign({parentName:"a"},{"aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"}),Object(n.b)("path",Object.assign({parentName:"svg"},{fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"})))),"Conclusion"),Object(n.b)("p",null,"Animating layout in the browser is hard, but Framer and Framer Motion are presenting it in an accessible way, removing all the friction from handoff."),Object(n.b)("p",null,"Thanks to the foundations of the FLIP technique, we can do this at 60fps. By accounting for tree transformations, its possible to correct scale distortions throughout an infinitely deep tree, on size, position and even CSS styles like ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"box-shadow")," and ",Object(n.b)("code",Object.assign({parentName:"p"},{className:"language-text"}),"border-radius"),"."),Object(n.b)("p",null,"If you’re a designer, sign up for the ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://www.framer.com/web/"}),"Framer beta"),", and if you’re a developer you can try out the new ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://framer.com/api/motion/animation/#automatic-(beta)"}),"auto-animate")," and ",Object(n.b)("a",Object.assign({parentName:"p"},{href:"https://framer.com/api/motion/animate-shared-layout"}),"shared layout")," features in the Framer Motion 2 open beta right now!"))}l.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-20200409-inside-magic-motion-mdx-bc018becc0aa396adf85.js.map